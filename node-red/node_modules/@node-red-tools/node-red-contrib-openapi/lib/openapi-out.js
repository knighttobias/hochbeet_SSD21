"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var queue_1 = require("./queue");
module.exports = function register(RED) {
    RED.nodes.registerType('openapi-out', function openapiOutNode(props) {
        var _this = this;
        RED.nodes.createNode(this, props);
        this.statusCode = props.statusCode || '500';
        this.fromMessage = props.fromMessage || false;
        this.on('input', function (msg) {
            var id = msg.___openapiReqID;
            if (!id) {
                _this.error('Request ID not found');
                return;
            }
            try {
                queue_1.dequeue(id, function (_, res, __) {
                    var statusCode = '500';
                    if (_this.fromMessage && msg.statusCode) {
                        statusCode = msg.statusCode.toString();
                    }
                    else {
                        statusCode = _this.statusCode;
                    }
                    res.status(parseFloat(statusCode));
                    if (typeof msg.payload !== 'undefined') {
                        res.send(msg.payload);
                    }
                    else {
                        res.end();
                    }
                });
            }
            catch (err) {
                _this.error(err);
            }
        });
    });
};
